<script>
    const tokenRate = 3333.33; // Number of tokens per XRP
    const sellerWalletAddress = "r3fxHfL5HSnMhPHtw6i7nrCQEABYk3m3Y5"; // Replace with actual wallet
    const xrpWebsocket = "wss://xrplcluster.com"; // XRPL WebSocket API

    document.getElementById('xrpAmount').addEventListener('input', (e) => {
        const xrp = parseFloat(e.target.value) || 0;
        document.getElementById('tokenAmount').innerText = `Tokens you will receive: ${xrp * tokenRate}`;
    });

    function generateQRCode() {
        const xrpAmount = parseFloat(document.getElementById('xrpAmount').value);

        if (!xrpAmount || xrpAmount <= 0) {
            alert("Please enter a valid XRP amount.");
            return;
        }

        const xrpInDrops = Math.round(xrpAmount * 1_000_000); // Convert XRP to drops

        // XRPL Payment URI with Memo (for Xaman compatibility)
        const paymentURI = `xrpl:${sellerWalletAddress}?amount=${xrpInDrops}&dt=0&memo=VALX%20Presale`;

        // Generate QR Code
        const qrCanvas = document.getElementById('qrcode');
        QRCode.toCanvas(qrCanvas, paymentURI, { width: 200 });

        // Show modal
        document.getElementById('qrModal').style.display = 'block';
        document.getElementById('qrModalOverlay').style.display = 'block';

        // Start listening for transaction confirmation
        listenForTransaction(xrpInDrops);
    }

    function closeModal() {
        document.getElementById('qrModal').style.display = 'none';
        document.getElementById('qrModalOverlay').style.display = 'none';
    }

    function listenForTransaction(amountInDrops) {
        const ws = new WebSocket(xrpWebsocket);

        ws.onopen = () => {
            console.log("Connected to XRPL WebSocket");

            // Subscribe to transactions for this wallet
            const subscribeMessage = {
                "command": "subscribe",
                "accounts": [sellerWalletAddress]
            };
            ws.send(JSON.stringify(subscribeMessage));
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === "transaction" && data.transaction) {
                const tx = data.transaction;
                
                if (tx.TransactionType === "Payment" &&
                    tx.Destination === sellerWalletAddress &&
                    tx.Amount === amountInDrops.toString() &&
                    tx.Memos &&
                    tx.Memos[0].Memo.MemoData === toHex("VALX Presale")) {

                    alert("Transaction Confirmed! Thank you for purchasing VALX.");
                    ws.close();
                }
            }
        };

        ws.onerror = (error) => {
            console.error("XRPL WebSocket Error:", error);
        };

        ws.onclose = () => {
            console.log("Disconnected from XRPL WebSocket");
        };
    }

    function toHex(str) {
        return Array.from(str).map(c => c.charCodeAt(0).toString(16).padStart(2, '0')).join('').toUpperCase();
    }
</script>
